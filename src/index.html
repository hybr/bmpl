<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="msapplication-tap-highlight" content="no" />

  <title>V4L - Vocal 4 Local</title>
  <meta name="description" content="Connecting Local Businesses with Local Customers - V4L (Vocal 4 Local) brings together local businesses and their community." />
  <meta name="keywords" content="local business, local customers, community, marketplace, vocal 4 local, v4l" />
  <meta name="author" content="V4L Team" />

  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3880ff" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="V4L" />
  <link rel="manifest" href="/manifest.json" />

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/icons/icon.svg" />

  <!-- Open Graph / Social Media -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://v4l.app/" />
  <meta property="og:title" content="V4L - Vocal 4 Local" />
  <meta property="og:description" content="Connecting Local Businesses with Local Customers" />
  <meta property="og:image" content="https://v4l.app/og-image.png" />

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://v4l.app/" />
  <meta property="twitter:title" content="V4L - Vocal 4 Local" />
  <meta property="twitter:description" content="Connecting Local Businesses with Local Customers" />
  <meta property="twitter:image" content="https://v4l.app/og-image.png" />

  <!-- Ionic Core CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@8/css/ionic.bundle.css" />

  <!-- Bootstrap Custom Build -->
  <link rel="stylesheet" href="/scss/bootstrap-custom.scss" />

  <!-- Compatibility Bridge -->
  <link rel="stylesheet" href="/scss/ionic-bootstrap-bridge.scss" />

  <!-- Custom Components -->
  <link rel="stylesheet" href="/scss/custom-components.scss" />

  <!-- Lookup Components (Form Generator) -->
  <link rel="stylesheet" href="/scss/lookup-components.scss" />

  <!-- Marketplace Components -->
  <link rel="stylesheet" href="/scss/marketplace.scss" />

  <!-- Process Components (BPM) -->
  <link rel="stylesheet" href="/scss/process-components.scss" />

  <!-- Notifications & Members -->
  <link rel="stylesheet" href="/scss/notifications.scss" />

  <!-- Custom Legacy Components -->
  <link rel="stylesheet" href="/scss/custom-legacy.scss" />

  <!-- Capacitor -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@8/dist/ionic/ionic.js"></script>

  <!-- PouchDB from CDN (loaded before app to avoid Vite bundling issues) -->
  <!-- Using PouchDB 7.3.1 with pouchdb-find plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pouchdb/7.3.1/pouchdb.min.js"></script>
  <script>
    // Load pouchdb-find plugin dynamically and register it
    (function() {
      if (!window.PouchDB) {
        console.error('PouchDB failed to load from CDN');
        return;
      }

      // Create a simple find polyfill that works with basic queries
      // This adds createIndex and find methods to PouchDB instances
      var findPlugin = {
        createIndex: function(opts) {
          var self = this;
          // Store index definition in a special document
          return self.get('_local/_indexes').catch(function() {
            return { _id: '_local/_indexes', indexes: [] };
          }).then(function(doc) {
            var indexDef = JSON.stringify(opts.index);
            if (doc.indexes.indexOf(indexDef) === -1) {
              doc.indexes.push(indexDef);
            }
            return self.put(doc).catch(function() {
              // Ignore conflicts
              return { ok: true };
            });
          }).then(function() {
            return { result: 'created' };
          });
        },
        find: function(opts) {
          var self = this;
          var selector = opts.selector || {};
          var limit = opts.limit || 25;
          var skip = opts.skip || 0;

          return self.allDocs({ include_docs: true }).then(function(result) {
            var docs = result.rows
              .map(function(row) { return row.doc; })
              .filter(function(doc) { return doc && !doc._id.startsWith('_'); });

            // Apply selector filtering
            var filtered = docs.filter(function(doc) {
              return matchSelector(doc, selector);
            });

            // Apply skip and limit
            var sliced = filtered.slice(skip, skip + limit);

            return { docs: sliced };
          });
        }
      };

      // Simple selector matching
      function matchSelector(doc, selector) {
        for (var key in selector) {
          if (key === '$or') {
            var orMatch = selector[key].some(function(sub) {
              return matchSelector(doc, sub);
            });
            if (!orMatch) return false;
          } else if (key === '$and') {
            var andMatch = selector[key].every(function(sub) {
              return matchSelector(doc, sub);
            });
            if (!andMatch) return false;
          } else if (key === '$in') {
            continue; // Skip $in at top level
          } else {
            var value = selector[key];
            var docValue = doc[key];

            if (typeof value === 'object' && value !== null) {
              // Handle operators
              if ('$eq' in value && docValue !== value.$eq) return false;
              if ('$ne' in value && docValue === value.$ne) return false;
              if ('$gt' in value && !(docValue > value.$gt)) return false;
              if ('$gte' in value && !(docValue >= value.$gte)) return false;
              if ('$lt' in value && !(docValue < value.$lt)) return false;
              if ('$lte' in value && !(docValue <= value.$lte)) return false;
              if ('$in' in value && value.$in.indexOf(docValue) === -1) return false;
              if ('$regex' in value) {
                var regex = value.$regex;
                if (typeof regex === 'string') regex = new RegExp(regex, 'i');
                if (!regex.test(docValue || '')) return false;
              }
            } else {
              // Direct equality
              if (docValue !== value) return false;
            }
          }
        }
        return true;
      }

      // Register the plugin
      PouchDB.plugin(findPlugin);
      console.log('PouchDB find polyfill registered');

      // Verify
      var testDb = new PouchDB('__pouchdb_test__');
      if (typeof testDb.createIndex === 'function' && typeof testDb.find === 'function') {
        console.log('PouchDB with find methods ready');
      }
      testDb.close();
    })();
  </script>
</head>

<body>
  <ion-app>
    <!-- Mock Mode Banner -->
    <div id="mock-mode-banner" class="mock-mode-banner hidden">
      <ion-icon name="flask-outline"></ion-icon>
      <span>Development Mode - No backend required</span>
    </div>

    <!-- Router Outlet -->
    <ion-router-outlet id="main-outlet"></ion-router-outlet>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading...</p>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>
  </ion-app>

  <!-- App Initialization -->
  <script type="module" src="/js/app.js"></script>
</body>
</html>
