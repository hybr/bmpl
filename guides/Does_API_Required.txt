an API in front of CouchDB.
For a multi-tenant ERP (user-created organizations) with Web + Mobile (Capacitor) + PouchDB, a hybrid architecture is the correct and proven approach.

Below is a clear, battle-tested architecture tailored for your case.

Why direct CouchDB access alone is NOT enough for an ERP

Your app has all the hard problems:

Multi-tenant (many organizations)

Role-based access (owner, admin, accountant, staff, etc.)

Sensitive data (finance, invoices, payroll)

Web + Mobile

Offline support

CouchDB cannot safely enforce all of this by itself.

âœ… Recommended Architecture (Industry-grade)
Mobile (Capacitor + PouchDB)
Web (PouchDB)
        â†“ sync (restricted)
     CouchDB  â†â†’  API Server
                    â†“
              Auth, Billing,
              Workflows, Reports

Responsibilities Breakdown (IMPORTANT)
1ï¸âƒ£ API Server (MANDATORY)

This is your source of truth.

Must handle:

Authentication (JWT / OAuth)

Organization creation

User â†” organization mapping

Role & permission logic

Subscription / plan limits

Cross-module workflows

Reporting & exports

Admin operations

Webhooks / integrations

Tech choices

Node.js (Fastify / NestJS)

Python (FastAPI)

Java (Spring Boot)

2ï¸âƒ£ CouchDB (Data + Sync Engine)

Use CouchDB only for what itâ€™s great at:

Document storage

Replication

Conflict handling

Offline-first sync

ğŸš« Do NOT expose CouchDB directly to the internet without restrictions.

3ï¸âƒ£ PouchDB (Client-side)

Each user gets:

Local database

Offline operations

Background sync

But sync is filtered and scoped.

ğŸ” Multi-Tenancy Strategy (CRITICAL)
Best approach: One database per organization
org_acme
org_xyz
org_foo


Advantages

Strong data isolation

Easy backup / delete

Simple security rules

Easier compliance

Sync filter

User can only sync databases they are authorized for

Alternative (not recommended for ERP)

Single DB with orgId field
â†’ Complex filters, higher risk, harder audits

ğŸ” Authentication Flow (Clean & Secure)
Step 1: Login via API
Client â†’ API â†’ JWT


JWT contains:

userId

orgIds

roles

subscription plan

Step 2: API provisions CouchDB access

Creates CouchDB user

Assigns DB permissions

Returns:

CouchDB URL

Username

Session token / password

Step 3: PouchDB sync
PouchDB.sync(localDB, remoteDB, {
  live: true,
  retry: true
});


âœ” Only allowed org DB
âœ” No admin rights
âœ” No access to other orgs

ğŸ“„ Data Rules Enforcement
Where rules live
Rule Type	Where
Field validation	API
Business logic	API
Cross-doc rules	API
Simple validation	CouchDB validate_doc_update
Offline conflict resolution	Client + API

Never trust the client alone.

ğŸ“Š Reporting & Heavy Queries

ERP reports should:

NEVER run from client

NEVER run from raw CouchDB views directly

Instead:

Client â†’ API â†’ Aggregation DB / Cached Views


Use:

Precomputed materialized views

Background jobs

CSV / Excel export via API

ğŸ”„ Offline Sync Rules

Allow offline:

Draft invoices

Expenses

Inventory movements

Notes

Require online:

Final posting

Tax submission

Locking periods

Payments

API enforces state transitions.

ğŸš« What NOT to do

âŒ Expose CouchDB admin creds
âŒ Let client choose database names
âŒ Put core business logic in design docs
âŒ Trust _security alone
âŒ One DB for all organizations

Minimal Tech Stack Suggestion

Backend

FastAPI / NestJS

Redis (cache + rate limit)

PostgreSQL (auth, orgs, billing metadata)

CouchDB (ERP documents)

Frontend

Web: React + PouchDB

Mobile: Capacitor + PouchDB

Final Verdict

ğŸ‘‰ Yes, an API layer is non-negotiable for your ERP.
ğŸ‘‰ CouchDB is your sync + document store, not your backend.
ğŸ‘‰ This architecture scales cleanly to thousands of orgs.